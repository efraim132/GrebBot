{% extends "base.html" %}

{% block title %}Dashboard - GrebBot{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-8">
        <!-- Bot Status Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot"></i> Bot Status</h5>
            </div>
            <div class="card-body">
                <div class="row" id="bot-status-content">
                    <div class="col-md-6">
                        <p><strong>Status:</strong> <span id="bot-status">Loading...</span></p>
                        <p><strong>Username:</strong> <span id="bot-username">Loading...</span></p>
                        <p><strong>User ID:</strong> <span id="bot-user-id">Loading...</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Latency:</strong> <span id="bot-latency">Loading...</span></p>
                        <p><strong>Guilds:</strong> <span id="bot-guild-count">Loading...</span></p>
                        <p><strong>Total Members:</strong> <span id="bot-member-count">Loading...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-discord w-100" onclick="refreshStatus()">
                            <i class="fas fa-sync"></i> Refresh Status
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-success w-100" onclick="viewLogs()">
                            <i class="fas fa-file-alt"></i> View Logs
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-info w-100" onclick="viewCommands()">
                            <i class="fas fa-terminal"></i> Commands
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-warning w-100" onclick="viewSettings()">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guilds Overview -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-server"></i> Server Overview</h5>
            </div>
            <div class="card-body">
                <div id="guilds-list">
                    <p>Loading server information...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- System Info Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> System Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Version:</strong> <span id="bot-version">Loading...</span></p>
                <p><strong>Debug Mode:</strong> <span id="debug-mode">Loading...</span></p>
                <p><strong>Uptime:</strong> <span id="bot-uptime">Loading...</span></p>
                <p><strong>Web Interface:</strong> <span class="status-online">Online</span></p>
            </div>
        </div>

        <!-- Recent Logs Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list"></i> Recent Activity</h5>
            </div>
            <div class="card-body">
                <div id="recent-logs" style="max-height: 300px; overflow-y: auto;">
                    <p>Loading recent activity...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let startTime = Date.now();

    function refreshStatus() {
        updateBotStatus();
        loadGuilds();
        loadSettings();
        loadRecentLogs();
    }

    function viewLogs() {
        window.location.href = "{{ url_for('logs') }}";
    }

    function viewCommands() {
        window.location.href = "{{ url_for('commands') }}";
    }

    function viewSettings() {
        window.location.href = "{{ url_for('settings') }}";
    }

    function updateBotStatus() {
        fetch('/api/bot/status')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('bot-status').innerHTML = '<span class="status-offline">Error</span>';
                    document.getElementById('bot-username').textContent = 'N/A';
                    document.getElementById('bot-user-id').textContent = 'N/A';
                    document.getElementById('bot-latency').textContent = 'N/A';
                    document.getElementById('bot-guild-count').textContent = 'N/A';
                    document.getElementById('bot-member-count').textContent = 'N/A';
                } else {
                    const statusClass = data.status === 'online' ? 'status-online' : 'status-offline';
                    document.getElementById('bot-status').innerHTML = `<span class="${statusClass}">${data.status}</span>`;
                    document.getElementById('bot-username').textContent = data.username || 'N/A';
                    document.getElementById('bot-user-id').textContent = data.user_id || 'N/A';
                    document.getElementById('bot-latency').textContent = data.latency ? `${data.latency}ms` : 'N/A';
                    document.getElementById('bot-guild-count').textContent = data.guild_count || '0';
                    document.getElementById('bot-member-count').textContent = data.total_members || '0';
                }
            })
            .catch(error => {
                console.error('Error fetching bot status:', error);
            });
    }

    function loadGuilds() {
        fetch('/api/bot/status')
            .then(response => response.json())
            .then(data => {
                const guildsList = document.getElementById('guilds-list');
                if (data.guilds && data.guilds.length > 0) {
                    let html = '<div class="row">';
                    data.guilds.forEach(guild => {
                        html += `
                            <div class="col-md-6 mb-2">
                                <div class="p-2 border rounded">
                                    <strong>${guild.name}</strong><br>
                                    <small class="text-muted">Members: ${guild.member_count}</small>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    guildsList.innerHTML = html;
                } else {
                    guildsList.innerHTML = '<p class="text-muted">No servers found or bot is offline.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading guilds:', error);
                document.getElementById('guilds-list').innerHTML = '<p class="text-danger">Error loading server information.</p>';
            });
    }

    function loadSettings() {
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                document.getElementById('bot-version').textContent = data.version || 'Unknown';
                document.getElementById('debug-mode').textContent = data.debug_mode ? 'Enabled' : 'Disabled';
            })
            .catch(error => {
                console.error('Error loading settings:', error);
            });
    }

    function loadRecentLogs() {
        fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                const recentLogs = document.getElementById('recent-logs');
                if (data.logs && data.logs.length > 0) {
                    let html = '';
                    data.logs.slice(-5).reverse().forEach(log => {
                        const levelClass = `log-${log.level.toLowerCase()}`;
                        html += `
                            <div class="log-entry ${levelClass}">
                                <small class="text-muted">[${log.timestamp}]</small><br>
                                ${log.message}
                            </div>
                        `;
                    });
                    recentLogs.innerHTML = html;
                } else {
                    recentLogs.innerHTML = '<p class="text-muted">No recent activity.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading logs:', error);
            });
    }

    function updateUptime() {
        const uptime = Date.now() - startTime;
        const seconds = Math.floor(uptime / 1000) % 60;
        const minutes = Math.floor(uptime / (1000 * 60)) % 60;
        const hours = Math.floor(uptime / (1000 * 60 * 60));

        document.getElementById('bot-uptime').textContent =
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Socket.IO listeners for real-time updates
    socket.on('new_log', function(log) {
        loadRecentLogs(); // Refresh recent logs when new log arrives
    });

    // Initial load
    refreshStatus();

    // Update uptime every second
    setInterval(updateUptime, 1000);

    // Refresh data every 30 seconds
    setInterval(refreshStatus, 30000);
</script>
{% endblock %}
